package com.example.demo;

import java.net.URI;

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.SpringBootTest.WebEnvironment;
import org.springframework.boot.test.web.client.TestRestTemplate;
import org.springframework.boot.web.server.LocalServerPort;
import org.springframework.http.HttpHeaders;
import org.springframework.http.ResponseEntity;
import org.springframework.test.context.junit.jupiter.SpringExtension;

@ExtendWith(SpringExtension.class)
@SpringBootTest(webEnvironment=WebEnvironment.RANDOM_PORT)
class DemoApplicationTests {

	@Autowired
    private TestRestTemplate restTemplate;
     
    @LocalServerPort
	int randomServerPort;

	@Test
	void whenNoXXEProtection_thenCallsOut() throws Exception {
	
		String vulnerableUrl = "http://localhost:"+randomServerPort+"/consumexml";
		String phoneHomeBase = "http://localhost:"+randomServerPort+"/phonehome/";
		String phoneHomeUrl = phoneHomeBase+"set";
		
		String xxe =  
			"<?xml version=\"1.0\" ?>" +
			"<!DOCTYPE root [" +
			"<!ENTITY % ext SYSTEM \""+phoneHomeUrl+"\"> %ext;" +
			"]>" +
			"<r></r>";

		// post XXE
		URI uri = new URI(vulnerableUrl);
        HttpHeaders headers = new HttpHeaders();
        headers.set("Content-Type", "application/xml");      
        ResponseEntity<String> result = this.restTemplate.postForEntity(uri, xxe, String.class);
		
        Assertions.assertEquals(200, result.getStatusCodeValue());

		// check that XXE worked
		String phonedHomeCheckUrl = phoneHomeBase+"get";
		ResponseEntity<Boolean> checkResult = this.restTemplate.getForEntity(phonedHomeCheckUrl, Boolean.class);
		
		Assertions.assertEquals(200, checkResult.getStatusCodeValue());
		Assertions.assertEquals(Boolean.TRUE, checkResult.getBody());
	}
}